{% extends 'base_back.html.twig' %}

{% block title %}Gestion des Tournois - ARENA Admin{% endblock %}

{% block body %}
<div class="admin-header d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1">Gestion des Tournois</h1>
        <p class="text-muted small mb-0">Visualisez, recherchez et gérez tous les tournois de la plateforme.</p>
    </div>
    <a href="{{ path('app_back_matchy_new') }}" class="btn-admin btn-admin-primary">
        <i class="fas fa-plus"></i> Nouveau Tournoi
    </a>
</div>

<div class="admin-card mb-4">
    <form id="filterForm" action="{{ path('app_back_matchy_index') }}" method="get" class="row g-3">
        <div class="col-md-3">
            <label class="small text-muted mb-2">RECHERCHE</label>
            <input type="text" name="query" class="form-control" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;" placeholder="Nom ou jeu..." value="{{ searchQuery }}">
        </div>
        <div class="col-md-2">
            <label class="small text-muted mb-2">JEU</label>
            <select name="game" class="form-select" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;">
                <option value="" style="background: #1a1a1a; color: white;">Tous les jeux</option>
                <option value="Valorant" {% if filters.game|default('') == 'Valorant' %}selected{% endif %} style="background: #1a1a1a; color: white;">Valorant</option>
                <option value="CS:GO" {% if filters.game|default('') == 'CS:GO' %}selected{% endif %} style="background: #1a1a1a; color: white;">CS:GO</option>
                <option value="League of Legends" {% if filters.game|default('') == 'League of Legends' %}selected{% endif %} style="background: #1a1a1a; color: white;">League of Legends</option>
                <option value="Rocket League" {% if filters.game|default('') == 'Rocket League' %}selected{% endif %} style="background: #1a1a1a; color: white;">Rocket League</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="small text-muted mb-2">PHASE</label>
            <select name="phase" class="form-select" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;">
                <option value="" style="background: #1a1a1a; color: white;">Toutes les phases</option>
                <option value="Inscriptions" {% if filters.phase|default('') == 'Inscriptions' %}selected{% endif %} style="background: #1a1a1a; color: white;">Inscriptions</option>
                <option value="Qualifications" {% if filters.phase|default('') == 'Qualifications' %}selected{% endif %} style="background: #1a1a1a; color: white;">Qualifications</option>
                <option value="Playoffs" {% if filters.phase|default('') == 'Playoffs' %}selected{% endif %} style="background: #1a1a1a; color: white;">Playoffs</option>
                <option value="Finale" {% if filters.phase|default('') == 'Finale' %}selected{% endif %} style="background: #1a1a1a; color: white;">Finale</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="small text-muted mb-2">STATUT</label>
            <select name="isActive" class="form-select" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;">
                <option value="" style="background: #1a1a1a; color: white;">Tous les statuts</option>
                <option value="1" {% if filters.isActive|default('') == '1' %}selected{% endif %} style="background: #1a1a1a; color: white;">Actif</option>
                <option value="0" {% if filters.isActive|default('') == '0' %}selected{% endif %} style="background: #1a1a1a; color: white;">Inactif</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="small text-muted mb-2">TRIER PAR</label>
            <select name="sort" class="form-select" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;">
                <option value="startDate" {% if currentSort == 'startDate' %}selected{% endif %} style="background: #1a1a1a; color: white;">Date de début</option>
                <option value="name" {% if currentSort == 'name' %}selected{% endif %} style="background: #1a1a1a; color: white;">Nom</option>
                <option value="game" {% if currentSort == 'game' %}selected{% endif %} style="background: #1a1a1a; color: white;">Jeu</option>
            </select>
        </div>
        <div class="col-md-1">
            <label class="small text-muted mb-2">ORDRE</label>
            <select name="order" class="form-select" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;">
                <option value="DESC" {% if currentOrder == 'DESC' %}selected{% endif %} style="background: #1a1a1a; color: white;">DESC</option>
                <option value="ASC" {% if currentOrder == 'ASC' %}selected{% endif %} style="background: #1a1a1a; color: white;">ASC</option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="small text-muted mb-2">DEBUT MIN</label>
            <input type="date" name="minDate" class="form-control" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;" value="{{ filters.minDate|default('') }}">
        </div>
        <div class="col-md-3">
            <label class="small text-muted mb-2">FIN MAX</label>
            <input type="date" name="maxDate" class="form-control" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;" value="{{ filters.maxDate|default('') }}">
        </div>
        <div class="col-md-6 d-flex align-items-end gap-2">
            <button type="submit" class="btn-admin btn-admin-primary flex-grow-1">Appliquer les Filtres</button>
            <a href="{{ path('app_back_matchy_index') }}" class="btn-admin btn-admin-secondary"><i class="fas fa-sync-alt"></i></a>
        </div>
    </form>
</div>

<div class="admin-card p-0 overflow-hidden position-relative">
    <div id="adminLoadingSpinner" class="position-absolute top-50 start-50 translate-middle" style="display: none; z-index: 10;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <table class="admin-table mb-0">
        <thead>
            <tr>
                <th>Nom</th>
                <th>Jeu</th>
                <th>Dates</th>
                <th>Statut</th>
                <th class="text-end">Actions</th>
            </tr>
        </thead>
        <tbody id="tournamentTableBody">
            {% include 'admin/tournament/_table_body.html.twig' %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('filterForm');
        const tableBody = document.getElementById('tournamentTableBody');
        const spinner = document.getElementById('adminLoadingSpinner');
        const inputs = form.querySelectorAll('input, select');
        
        let timeout = null;

        function updateTable() {
            spinner.style.display = 'block';
            tableBody.style.opacity = '0.5';

            const formData = new FormData(form);
            const params = new URLSearchParams(formData);

            fetch(`${window.location.pathname}?${params.toString()}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                tableBody.innerHTML = html;
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                spinner.style.display = 'none';
                tableBody.style.opacity = '1';
            });
        }

        inputs.forEach(input => {
            input.addEventListener('input', () => {
                clearTimeout(timeout);
                timeout = setTimeout(updateTable, 300);
            });
            
            if (input.tagName === 'SELECT') {
                input.addEventListener('change', updateTable);
            }
        });

        // Prevent normal form submission to keep AJAX feel
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            updateTable();
        });
    });
</script>
{% endblock %}
