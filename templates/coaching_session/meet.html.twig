{% extends 'base.html.twig' %}

{% block title %}Réunion Coaching - Session #{{ coaching_session.id }}{% endblock %}

{% block body %}
<div class="meet-container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <div class="meet-header" style="background: linear-gradient(135deg, #ff0000, #ff2d2d); color: white; padding: 20px; border-radius: 10px 10px 0 0; margin-bottom: -1px;">
        <h1 style="margin: 0; font-size: 24px;">
            <i class="fas fa-video"></i> RÉUNION DE COACHING
        </h1>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
            <div>
                <strong>Session #{{ coaching_session.id }}</strong> • 
                Coach #{{ coaching_session.coachId }} • 
                Équipe #{{ coaching_session.teamId }}
            </div>
            <div>
                <a href="{{ path('app_coaching_session_index') }}" 
                   class="btn" 
                   style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>
        </div>
    </div>
    
    <div id="jitsi-container" style="height: 600px; border: 3px solid #ff0000; border-radius: 0 0 10px 10px;"></div>
    
    <div class="session-info" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px;">
        <h3 style="color: #ff0000; margin-top: 0;">
            <i class="fas fa-info-circle"></i> Informations de la session
        </h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            <div>
                <strong>Date :</strong><br>
                {{ coaching_session.sessionDate ? coaching_session.sessionDate|date('d/m/Y H:i') : 'Non définie' }}
            </div>
            <div>
                <strong>Durée :</strong><br>
                {{ coaching_session.duration }} minutes
            </div>
            <div>
                <strong>Plan d'entraînement :</strong><br>
                {% if coaching_session.trainingPlan %}
                    {{ coaching_session.trainingPlan.title }}
                {% else %}
                    Aucun plan assigné
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://meet.jit.si/external_api.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const domain = "meet.jit.si";
    
    // Configuration pour Jitsi Meet
    const options = {
        roomName: "{{ room_name }}",
        width: "100%",
        height: 600,
        parentNode: document.querySelector('#jitsi-container'),
        userInfo: {
            displayName: "{% if app.user %}{{ app.user.username }}{% else %}Invité{% endif %}",
            email: "{% if app.user %}{{ app.user.email }}{% endif %}"
        },
        interfaceConfigOverwrite: {
            TOOLBAR_BUTTONS: [
                'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
                'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
                'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
                'videoquality', 'filmstrip', 'feedback', 'stats', 'shortcuts',
                'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone',
                'e2ee'
            ],
            SHOW_JITSI_WATERMARK: false,
            SHOW_WATERMARK_FOR_GUESTS: false,
            DEFAULT_BACKGROUND: '#ff0000',
            DEFAULT_REMOTE_DISPLAY_NAME: 'Participant',
            DEFAULT_LOCAL_DISPLAY_NAME: 'Vous',
            SHOW_CHROME_EXTENSION_BANNER: false
        },
        configOverwrite: {
            disableDeepLinking: true,
            prejoinPageEnabled: false,
            startWithAudioMuted: false,
            startWithVideoMuted: false,
            enableWelcomePage: false,
            enableClosePage: false,
            disableInviteFunctions: true
        }
    };

    try {
        const api = new JitsiMeetExternalAPI(domain, options);
        
        // Événements Jitsi
        api.addEventListener('videoConferenceJoined', () => {
            console.log('Rejoint la conférence');
        });
        
        api.addEventListener('readyToClose', () => {
            window.location.href = "{{ path('app_coaching_session_index') }}";
        });
        
    } catch (error) {
        console.error('Erreur Jitsi:', error);
        document.getElementById('jitsi-container').innerHTML = `
            <div style="text-align: center; padding: 50px; background: #ffebee; border-radius: 10px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #d32f2f;"></i>
                <h3 style="color: #d32f2f;">Erreur de connexion</h3>
                <p>Impossible de charger la réunion Jitsi. Vérifiez votre connexion internet.</p>
                <a href="{{ path('app_coaching_session_index') }}" class="btn" style="background: #d32f2f; color: white;">
                    Retour aux sessions
                </a>
            </div>
        `;
    }
});
</script>
{% endblock %}